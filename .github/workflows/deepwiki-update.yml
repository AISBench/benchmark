name: DeepWiki - Auto Update Knowledge Base
on:
  # 触发条件：推送代码、合并PR、发布版本
  push:
    branches: [ master ]  # 适配你的仓库主分支名称
  pull_request:
    branches: [ master ]
  issues:
    types: [ opened, edited, closed, labeled ]
  issue_comment:
    types: [ created, edited, deleted ]
  release:
    types: [ published ]

jobs:
  update-deepwiki:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出仓库代码
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整提交历史，便于DeepWiki解析

      # 2. 触发DeepWiki知识库更新
      - name: Trigger DeepWiki Sync via API
        run: |
          # 调用DeepWiki官方同步API，触发仓库知识库更新
          response=$(curl -s -X POST "https://api.deepwiki.com/v1/repo/sync" \
            -H "Content-Type: application/json" \
            -d '{
              "repo": "AISBench/benchmark",
              "token": "${{ secrets.GITHUB_TOKEN }}",
              "incremental": true,
              "exclude": ["build/", "dist/", "__pycache__/", "data/", "dataset/"]
            }')

          # 打印响应结果，便于调试
          echo "DeepWiki API Response: $response"

          # 检查同步是否成功
          if echo "$response" | grep -q '"success": true'; then
            echo "✅ DeepWiki 知识库同步触发成功"
          else
            echo "❌ DeepWiki 同步失败，响应：$response"
            exit 1  # 标记Action失败（可选）
          fi
        env:
          # 传递GITHUB_TOKEN到环境变量，避免JSON转义问题
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}